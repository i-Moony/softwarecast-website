---
import { getCollection } from "astro:content";
import YouTubeEmbed from "../../components/youtube-embed.astro";
import Details from "../../components/details.astro";
import Default from "../../layouts/default.astro";

import Link from "../../images/icons/external-link-dark.svg";

export async function getStaticPaths() {
    const episodes = await getCollection("episodes");

    return episodes.map((episode) => ({
        params: { id: episode.id },
        props: { episode },
    }));
}

const { episode } = Astro.props;
const episodes = await getCollection("episodes");
const previousEpisode = episodes.find(
    (ep) => ep.data.episode_number === episode.data.episode_number - 1,
);
const nextEpisode = episodes.find(
    (ep) => ep.data.episode_number === episode.data.episode_number + 1,
);

const title = episode.data.title + " - СофтварьКаст";
const description = episode.data.title;
const tags =
    "официально, official, эпизод" + episode.data.title.split(" ").join(",");

const localeOptions: Intl.DateTimeFormatOptions = {
    day: "numeric",
    month: "long",
    year: "numeric",
    weekday: "long",
    hour: "2-digit",
    minute: "2-digit",
};
---

<Default {title} {description} {tags}>
    <article>
        <div class="text-center mb-4 lg:mb-8 flex flex-col gap-2 items-center">
            <h1 class="font-intruder text-3xl lg:text-4xl xl:text-5xl">
                {episode.data.title}
            </h1>
            <!-- <a
                href={"/episodes/audio/" + episode.id}
                class="font-intruder text-xl lg:text-3xl xl:text-4xl underline underline-offset-4 xl:underline-offset-8 w-fit"
            >
                Переключить на аудио-версию
            </a> -->
            <section class="w-full px-2">
                {
                    previousEpisode && (
                        <a
                            href={"/episodes/" + previousEpisode.id}
                            class="float-left text-lg lg:text-xl xl:text-2xl font-intruder underline underline-offset-4 lg:underline-offset-8 text-wrap text-left"
                        >
                            Предыдущий
                            <br class="md:hidden" />
                            эпизод
                        </a>
                    )
                }
                {
                    nextEpisode && (
                        <a
                            href={"/episodes/" + nextEpisode.id}
                            class="float-right text-lg lg:text-xl xl:text-2xl font-intruder underline underline-offset-4 lg:underline-offset-8 text-wrap text-right"
                        >
                            Следующий
                            <br class="md:hidden" />
                            эпизод
                        </a>
                    )
                }
            </section>
        </div>
        <div class="flex flex-col gap-6">
            <section class="mx-2">
                <div class="rounded-2xl lg:rounded-3xl overflow-hidden w-full">
                    <YouTubeEmbed
                        preview={episode.data.preview}
                        title={episode.data.title}
                        videoId={episode.data.youtube_id}
                        class="w-full"
                    />
                </div>
            </section>
            <section
                class="w-full flex flex-col gap-6 bg-brand-blue/25 rounded-2xl lg:rounded-3xl shadow-lg border-2 border-brand-blue/15 py-3 px-8 md:py-6 md:px-12 xss:text-justify"
            >
                <Details
                    summary="Описание"
                    color="black"
                    name="description"
                    open={true}
                >
                    <p>{episode.data.description}</p>
                    <div>
                        <h3>Если вкратце, то я:</h3>
                        <ul class="list-disc pl-6">
                            {
                                episode.data.bullet_points.map((point) => (
                                    <li>{point}</li>
                                ))
                            }
                        </ul>
                    </div>
                </Details>
            </section>
            <section
                class="w-full flex flex-col gap-6 bg-brand-blue/25 rounded-2xl lg:rounded-3xl shadow-lg border-2 border-brand-blue/15 py-3 px-8 md:py-6 md:px-12"
            >
                {
                    episode.data.apps_mentioned && (
                        <Details
                            summary="Упомянутые программы"
                            color="black"
                            name="links"
                            open={true}
                        >
                            <ul class="list-disc pl-6">
                                {episode.data.apps_mentioned.map((app) => (
                                    <li>
                                        <a
                                            href={app.link}
                                            target="_blank"
                                            class="underline flex flex-row gap-1 items-center w-fit"
                                        >
                                            {app.title}
                                            <Link class="h-6 w-auto max-md:hidden" />
                                        </a>
                                    </li>
                                ))}
                            </ul>
                        </Details>
                    )
                }
                {
                    episode.data.learn_more && (
                        <Details
                            summary="Узнать больше"
                            color="black"
                            name="links"
                        >
                            <ul class="list-disc pl-6 xss:text-justify">
                                {episode.data.learn_more.map((resource) => (
                                    <li>
                                        <div class="flex flex-col gap-0.5">
                                            <a
                                                href={resource.link}
                                                target="_blank"
                                                class="underline w-fit"
                                            >
                                                {resource.title}
                                            </a>
                                            {resource.description && (
                                                <p>{resource.description}</p>
                                            )}
                                        </div>
                                    </li>
                                ))}
                            </ul>
                        </Details>
                    )
                }
            </section>
            <section class="w-full px-2">
                {
                    previousEpisode && (
                        <a
                            href={"/episodes/" + previousEpisode.id}
                            class="float-left text-lg lg:text-xl xl:text-2xl font-intruder underline underline-offset-4 lg:underline-offset-8 text-wrap text-left"
                        >
                            Предыдущий
                            <br class="md:hidden" />
                            эпизод
                        </a>
                    )
                }
                {
                    nextEpisode && (
                        <a
                            href={"/episodes/" + nextEpisode.id}
                            class="float-right text-lg lg:text-xl xl:text-2xl font-intruder underline underline-offset-4 lg:underline-offset-8 text-wrap text-right"
                        >
                            Следующий
                            <br class="md:hidden" />
                            эпизод
                        </a>
                    )
                }
            </section>
        </div>
    </article>
</Default>
